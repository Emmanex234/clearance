<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FUTO Clearance - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Include EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <!-- Include Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100">
    <!-- Navigation -->
    <nav class="bg-blue-800 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center">
                        <img class="h-8 w-auto" src="https://futo.edu.ng/wp-content/uploads/2020/10/cropped-FUTO-LOGO.png" alt="FUTO Logo">
                        <span class="ml-2 font-semibold">Admin Portal</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="hidden md:ml-4 md:flex md:items-center space-x-4">
                        <span class="text-sm font-medium">Welcome, Admin</span>
                        <button id="logoutBtn" class="bg-blue-700 px-3 py-1 rounded-md text-sm font-medium hover:bg-blue-600">
                            <i class="fas fa-sign-out-alt mr-1"></i> Log Out
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="flex flex-col md:flex-row gap-6">
            <!-- Sidebar -->
            <div class="w-full md:w-64 flex-shrink-0">
                <div class="bg-white rounded-lg shadow p-4">
                    <h3 class="font-bold text-lg mb-4 text-gray-800">Admin Menu</h3>
                    <ul class="space-y-2">
                        <li>
                            <a href="#" class="flex items-center px-3 py-2 text-sm font-medium rounded-md bg-blue-100 text-blue-800">
                                <i class="fas fa-tachometer-alt mr-3 text-blue-500"></i>
                                Dashboard
                            </a>
                        </li>
                        <li>
                            <a href="#students-tab" class="flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-users mr-3 text-gray-500"></i>
                                Student Clearances
                            </a>
                        </li>
                        <li>
                            <a href="#officers-tab" class="flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-user-tie mr-3 text-gray-500"></i>
                                Manage Officers
                            </a>
                        </li>
                        <li>
                            <a href="#departments-tab" class="flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-building mr-3 text-gray-500"></i>
                                Departments
                            </a>
                        </li>
                        <li>
                            <a href="#settings-tab" class="flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-cog mr-3 text-gray-500"></i>
                                Settings
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Dashboard Content -->
            <div class="flex-1">
                <!-- Tabs -->
                <div class="bg-white rounded-lg shadow overflow-hidden mb-6">
                    <div class="border-b border-gray-200">
                        <nav class="flex -mb-px">
                            <a href="#" id="dashboard-tab" class="border-b-2 border-blue-500 py-4 px-6 text-sm font-medium text-blue-600">Dashboard</a>
                            <a href="#" id="students-tab" class="border-b-2 border-transparent py-4 px-6 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300">Student Clearances</a>
                            <a href="#" id="officers-tab" class="border-b-2 border-transparent py-4 px-6 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300">Officers</a>
                            <a href="#" id="departments-tab" class="border-b-2 border-transparent py-4 px-6 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300">Departments</a>
                            <a href="#" id="settings-tab" class="border-b-2 border-transparent py-4 px-6 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300">Settings</a>
                        </nav>
                    </div>
                </div>

                <!-- Dashboard Tab Content -->
                <div id="dashboard-content" class="tab-content bg-white rounded-lg shadow overflow-hidden p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-6">System Overview</h2>
                    
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-blue-50 rounded-lg p-4 border border-blue-100">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                                    <i class="fas fa-users text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <h3 class="text-sm font-medium text-gray-600">Total Students</h3>
                                    <p id="total-students" class="text-2xl font-semibold text-gray-900">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4 border border-green-100">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-green-100 text-green-600">
                                    <i class="fas fa-check-circle text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <h3 class="text-sm font-medium text-gray-600">Cleared Students</h3>
                                    <p id="cleared-students" class="text-2xl font-semibold text-gray-900">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-yellow-50 rounded-lg p-4 border border-yellow-100">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                                    <i class="fas fa-exclamation-circle text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <h3 class="text-sm font-medium text-gray-600">Pending Clearances</h3>
                                    <p id="pending-clearances" class="text-2xl font-semibold text-gray-900">0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div>
                        <h3 class="text-lg font-medium text-gray-800 mb-4">Recent Clearance Activity</h3>
                        <div class="bg-gray-50 rounded-lg border border-gray-200 overflow-hidden">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    </tr>
                                </thead>
                                <tbody id="recent-activity" class="bg-white divide-y divide-gray-200">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Student Clearances Tab Content -->
                <div id="students-content" class="tab-content hidden bg-white rounded-lg shadow overflow-hidden p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold text-gray-800">Student Clearances</h2>
                        <div class="flex space-x-2">
                            <select id="status-filter" class="border border-gray-300 rounded-md px-3 py-1 text-sm">
                                <option value="all">All Statuses</option>
                                <option value="pending">Pending</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                            </select>
                            <input type="text" id="student-search" placeholder="Search students..." class="border border-gray-300 rounded-md px-3 py-1 text-sm">
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Matric No</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="students-table" class="bg-white divide-y divide-gray-200">
                                <!-- Will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <div class="flex items-center justify-between mt-4">
                        <div class="text-sm text-gray-500">
                            Showing <span id="start-item">1</span> to <span id="end-item">10</span> of <span id="total-items">0</span> entries
                        </div>
                        <div class="flex space-x-2">
                            <button id="prev-page" class="px-3 py-1 border rounded-md text-sm disabled:opacity-50" disabled>Previous</button>
                            <button id="next-page" class="px-3 py-1 border rounded-md text-sm disabled:opacity-50" disabled>Next</button>
                        </div>
                    </div>
                </div>

                <!-- Student Details Modal -->
                <div id="student-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
                    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-2/3 lg:w-1/2 shadow-lg rounded-md bg-white">
                        <div class="flex justify-between items-center border-b pb-3">
                            <h3 class="text-lg font-semibold text-gray-800" id="modal-title">Student Clearance Details</h3>
                            <button id="close-modal" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="mt-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <div>
                                    <p class="text-sm text-gray-500">Student Name</p>
                                    <p id="modal-student-name" class="font-medium">John Doe</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Matric Number</p>
                                    <p id="modal-matric-no" class="font-medium">2018/12345</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Department</p>
                                    <p id="modal-department" class="font-medium">Computer Science</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Faculty</p>
                                    <p id="modal-faculty" class="font-medium">School of Computing</p>
                                </div>
                            </div>
                            
                            <h4 class="font-medium text-gray-800 mb-2">Clearance Status by Unit</h4>
                            <div class="bg-gray-50 rounded-lg border border-gray-200 overflow-hidden mb-6">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit</th>
                                            <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                            <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        </tr>
                                    </thead>
                                    <tbody id="modal-clearance-status">
                                        <!-- Will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <div id="approval-section">
                                <h4 class="font-medium text-gray-800 mb-2">Admin Actions</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <button id="approve-clearance" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md">
                                            <i class="fas fa-check mr-2"></i> Approve Clearance
                                        </button>
                                    </div>
                                    <div>
                                        <button id="reject-clearance" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-md">
                                            <i class="fas fa-times mr-2"></i> Reject Clearance
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="reject-reason-section" class="mt-4 hidden">
                                <label for="reject-reason" class="block text-sm font-medium text-gray-700 mb-1">Reason for Rejection</label>
                                <textarea id="reject-reason" rows="3" class="w-full border border-gray-300 rounded-md p-2"></textarea>
                                <div class="mt-2 flex justify-end space-x-2">
                                    <button id="cancel-reject" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
                                    <button id="confirm-reject" class="px-4 py-2 border border-transparent rounded-md text-sm font-medium text-white bg-red-600 hover:bg-red-700">Submit Rejection</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize EmailJS with your user ID
        emailjs.init('YOUR_EMAILJS_USER_ID');
        
        // Initialize Supabase
        const supabaseUrl = 'YOUR_SUPABASE_URL';
        const supabaseKey = 'YOUR_SUPABASE_ANON_KEY';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);
        
        // Current user and pagination state
        let currentUser = null;
        let currentPage = 1;
        const itemsPerPage = 10;
        let totalStudents = 0;
        let selectedStudentId = null;
        
        document.addEventListener('DOMContentLoaded', async function() {
            // Check authentication
            await checkAuth();
            
            // Load dashboard data
            await loadDashboardData();
            
            // Setup event listeners
            setupEventListeners();
            
            // Load initial student data
            await loadStudents();
        });
        
        async function checkAuth() {
            const { data: { user }, error } = await supabase.auth.getUser();
            
            if (error || !user) {
                window.location.href = 'index.html';
                return;
            }
            
            currentUser = user;
            
            // Check if user is admin
            const { data: profile, error: profileError } = await supabase
                .from('profiles')
                .select('role')
                .eq('id', user.id)
                .single();
                
            if (profileError || !profile || profile.role !== 'admin') {
                window.location.href = 'index.html';
            }
        }
        
        async function loadDashboardData() {
            // Get total students
            const { count: total } = await supabase
                .from('profiles')
                .select('*', { count: 'exact', head: true })
                .eq('role', 'student');
                
            document.getElementById('total-students').textContent = total || 0;
            
            // Get cleared students count
            const { count: cleared } = await supabase
                .from('clearance_requests')
                .select('*', { count: 'exact', head: true })
                .eq('status', 'approved');
                
            document.getElementById('cleared-students').textContent = cleared || 0;
            
            // Get pending clearances count
            const { count: pending } = await supabase
                .from('clearance_requests')
                .select('*', { count: 'exact', head: true })
                .eq('status', 'pending');
                
            document.getElementById('pending-clearances').textContent = pending || 0;
            
            // Get recent activity
            const { data: recentActivity } = await supabase
                .from('clearance_requests')
                .select(`
                    id,
                    status,
                    updated_at,
                    profiles:student_id (name, matric_no, departments (name))
                `)
                .order('updated_at', { ascending: false })
                .limit(5);
                
            const activityTable = document.getElementById('recent-activity');
            activityTable.innerHTML = '';
            
            if (recentActivity && recentActivity.length > 0) {
                recentActivity.forEach(activity => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${activity.profiles.name}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-500">${activity.profiles.departments.name}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                ${activity.status === 'approved' ? 'bg-green-100 text-green-800' : 
                                  activity.status === 'rejected' ? 'bg-red-100 text-red-800' : 
                                  'bg-yellow-100 text-yellow-800'}">
                                ${activity.status.charAt(0).toUpperCase() + activity.status.slice(1)}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${new Date(activity.updated_at).toLocaleString()}
                        </td>
                    `;
                    activityTable.appendChild(row);
                });
            } else {
                activityTable.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500">
                            No recent activity found
                        </td>
                    </tr>
                `;
            }
        }
        
        async function loadStudents(page = 1, statusFilter = 'all', searchQuery = '') {
            currentPage = page;
            
            // Calculate offset for pagination
            const offset = (page - 1) * itemsPerPage;
            
            // Build the query
            let query = supabase
                .from('profiles')
                .select(`
                    id,
                    name,
                    matric_no,
                    email,
                    departments (name),
                    clearance_requests (id, status)
                `, { count: 'exact' })
                .eq('role', 'student')
                .range(offset, offset + itemsPerPage - 1);
                
            // Apply status filter if not 'all'
            if (statusFilter !== 'all') {
                query = query.contains('clearance_requests', [{ status: statusFilter }]);
            }
            
            // Apply search filter if provided
            if (searchQuery) {
                query = query.or(`name.ilike.%${searchQuery}%,matric_no.ilike.%${searchQuery}%`);
            }
            
            const { data: students, count, error } = await query;
            
            if (error) {
                console.error('Error loading students:', error);
                return;
            }
            
            totalStudents = count || 0;
            
            // Update pagination info
            document.getElementById('start-item').textContent = offset + 1;
            document.getElementById('end-item').textContent = Math.min(offset + itemsPerPage, totalStudents);
            document.getElementById('total-items').textContent = totalStudents;
            
            // Update pagination buttons
            document.getElementById('prev-page').disabled = page <= 1;
            document.getElementById('next-page').disabled = offset + itemsPerPage >= totalStudents;
            
            // Render students table
            const studentsTable = document.getElementById('students-table');
            studentsTable.innerHTML = '';
            
            if (students && students.length > 0) {
                students.forEach(student => {
                    // Determine overall status (simplified - in real app you'd check all clearance items)
                    const overallStatus = student.clearance_requests && student.clearance_requests.length > 0 ? 
                        student.clearance_requests[0].status : 'pending';
                    
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">${student.name}</div>
                                    <div class="text-sm text-gray-500">${student.email}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${student.matric_no}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${student.departments.name}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                ${overallStatus === 'approved' ? 'bg-green-100 text-green-800' : 
                                  overallStatus === 'rejected' ? 'bg-red-100 text-red-800' : 
                                  'bg-yellow-100 text-yellow-800'}">
                                ${overallStatus.charAt(0).toUpperCase() + overallStatus.slice(1)}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button data-student-id="${student.id}" class="text-blue-600 hover:text-blue-900 view-student">View</button>
                        </td>
                    `;
                    studentsTable.appendChild(row);
                });
            } else {
                studentsTable.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">
                            No students found
                        </td>
                    </tr>
                `;
            }
        }
        
        async function loadStudentDetails(studentId) {
            selectedStudentId = studentId;
            
            // Get student profile
            const { data: student, error: studentError } = await supabase
                .from('profiles')
                .select(`
                    id,
                    name,
                    matric_no,
                    email,
                    departments (name),
                    faculties (name),
                    clearance_requests (
                        id,
                        status,
                        updated_at,
                        clearance_items (name)
                `)
                .eq('id', studentId)
                .single();
                
            if (studentError) {
                console.error('Error loading student:', studentError);
                return;
            }
            
            // Update modal with student info
            document.getElementById('modal-student-name').textContent = student.name;
            document.getElementById('modal-matric-no').textContent = student.matric_no;
            document.getElementById('modal-department').textContent = student.departments.name;
            document.getElementById('modal-faculty').textContent = student.faculties.name;
            
            // Update clearance status table
            const statusTable = document.getElementById('modal-clearance-status');
            statusTable.innerHTML = '';
            
            if (student.clearance_requests && student.clearance_requests.length > 0) {
                student.clearance_requests.forEach(request => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">
                            ${request.clearance_items.name}
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                ${request.status === 'approved' ? 'bg-green-100 text-green-800' : 
                                  request.status === 'rejected' ? 'bg-red-100 text-red-800' : 
                                  'bg-yellow-100 text-yellow-800'}">
                                ${request.status.charAt(0).toUpperCase() + request.status.slice(1)}
                            </span>
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">
                            ${new Date(request.updated_at).toLocaleDateString()}
                        </td>
                    `;
                    statusTable.appendChild(row);
                });
            } else {
                statusTable.innerHTML = `
                    <tr>
                        <td colspan="3" class="px-4 py-2 text-center text-sm text-gray-500">
                            No clearance requests found
                        </td>
                    </tr>
                `;
            }
            
            // Show the modal
            document.getElementById('student-modal').classList.remove('hidden');
        }
        
        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('[id$="-tab"]').forEach(tab => {
                tab.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Hide all content
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    // Show selected content
                    const contentId = this.id.replace('-tab', '-content');
                    document.getElementById(contentId).classList.remove('hidden');
                    
                    // Update active tab styling
                    document.querySelectorAll('[id$="-tab"]').forEach(t => {
                        t.classList.remove('border-blue-500', 'text-blue-600');
                        t.classList.add('border-transparent', 'text-gray-500');
                    });
                    
                    this.classList.remove('border-transparent', 'text-gray-500');
                    this.classList.add('border-blue-500', 'text-blue-600');
                });
            });
            
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', async function() {
                const { error } = await supabase.auth.signOut();
                window.location.href = 'index.html';
            });
            
            // Student search and filter
            document.getElementById('status-filter').addEventListener('change', async function() {
                await loadStudents(1, this.value, document.getElementById('student-search').value);
            });
            
            document.getElementById('student-search').addEventListener('input', debounce(async function() {
                await loadStudents(1, document.getElementById('status-filter').value, this.value);
            }, 300));
            
            // Pagination
            document.getElementById('prev-page').addEventListener('click', async function() {
                if (currentPage > 1) {
                    await loadStudents(currentPage - 1, 
                        document.getElementById('status-filter').value, 
                        document.getElementById('student-search').value);
                }
            });
            
            document.getElementById('next-page').addEventListener('click', async function() {
                if ((currentPage * itemsPerPage) < totalStudents) {
                    await loadStudents(currentPage + 1, 
                        document.getElementById('status-filter').value, 
                        document.getElementById('student-search').value);
                }
            });
            
            // View student buttons (delegated event)
            document.getElementById('students-table').addEventListener('click', function(e) {
                if (e.target.classList.contains('view-student')) {
                    const studentId = e.target.getAttribute('data-student-id');
                    loadStudentDetails(studentId);
                }
            });
            
            // Modal close button
            document.getElementById('close-modal').addEventListener('click', function() {
                document.getElementById('student-modal').classList.add('hidden');
            });
            
            // Approve/reject buttons
            document.getElementById('approve-clearance').addEventListener('click', async function() {
                if (!selectedStudentId) return;
                
                // Show loading state
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';
                this.disabled = true;
                
                try {
                    // Update all clearance requests for this student to approved
                    const { error } = await supabase
                        .from('clearance_requests')
                        .update({ status: 'approved', updated_at: new Date().toISOString() })
                        .eq('student_id', selectedStudentId);
                        
                    if (error) throw error;
                    
                    // Send approval email
                    await sendClearanceEmail(selectedStudentId, 'approved');
                    
                    alert('Clearance approved successfully!');
                    document.getElementById('student-modal').classList.add('hidden');
                    await loadStudents(currentPage);
                    await loadDashboardData();
                } catch (error) {
                    console.error('Error approving clearance:', error);
                    alert('Failed to approve clearance. Please try again.');
                } finally {
                    this.innerHTML = originalText;
                    this.disabled = false;
                }
            });
            
            document.getElementById('reject-clearance').addEventListener('click', function() {
                document.getElementById('approval-section').classList.add('hidden');
                document.getElementById('reject-reason-section').classList.remove('hidden');
            });
            
            document.getElementById('cancel-reject').addEventListener('click', function() {
                document.getElementById('approval-section').classList.remove('hidden');
                document.getElementById('reject-reason-section').classList.add('hidden');
                document.getElementById('reject-reason').value = '';
            });
            
            document.getElementById('confirm-reject').addEventListener('click', async function() {
                const reason = document.getElementById('reject-reason').value.trim();
                if (!reason) {
                    alert('Please provide a reason for rejection');
                    return;
                }
                
                if (!selectedStudentId) return;
                
                // Show loading state
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';
                this.disabled = true;
                
                try {
                    // Update all clearance requests for this student to rejected
                    const { error } = await supabase
                        .from('clearance_requests')
                        .update({ 
                            status: 'rejected', 
                            updated_at: new Date().toISOString(),
                            rejection_reason: reason
                        })
                        .eq('student_id', selectedStudentId);
                        
                    if (error) throw error;
                    
                    // Send rejection email
                    await sendClearanceEmail(selectedStudentId, 'rejected', reason);
                    
                    alert('Clearance rejected successfully!');
                    document.getElementById('student-modal').classList.add('hidden');
                    document.getElementById('approval-section').classList.remove('hidden');
                    document.getElementById('reject-reason-section').classList.add('hidden');
                    document.getElementById('reject-reason').value = '';
                    
                    await loadStudents(currentPage);
                    await loadDashboardData();
                } catch (error) {
                    console.error('Error rejecting clearance:', error);
                    alert('Failed to reject clearance. Please try again.');
                } finally {
                    this.innerHTML = originalText;
                    this.disabled = false;
                }
            });
        }
        
        async function sendClearanceEmail(studentId, status, reason = '') {
            // Get student email
            const { data: student, error } = await supabase
                .from('profiles')
                .select('email, name')
                .eq('id', studentId)
                .single();
                
            if (error) {
                console.error('Error getting student email:', error);
                return;
            }
            
            // Prepare email parameters
            const templateParams = {
                to_email: student.email,
                to_name: student.name,
                status: status,
                reason: reason,
                date: new Date().toLocaleDateString()
            };
            
            try {
                // Send email using EmailJS
                await emailjs.send(
                    'YOUR_EMAILJS_SERVICE_ID', 
                    status === 'approved' ? 'YOUR_APPROVAL_TEMPLATE_ID' : 'YOUR_REJECTION_TEMPLATE_ID',
                    templateParams
                );
                
                console.log('Email sent successfully');
            } catch (emailError) {
                console.error('Failed to send email:', emailError);
            }
        }
        
        // Utility function for debouncing
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this, args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    func.apply(context, args);
                }, wait);
            };
        }
    </script>
</body>
</html>